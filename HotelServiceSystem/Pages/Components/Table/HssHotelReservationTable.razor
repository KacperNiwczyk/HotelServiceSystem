@using HotelServiceSystem.Entities
@using HotelServiceSystem.Core
@using HotelServiceSystem.Core.Helpers
@using HotelServiceSystem.Interfaces.Helpers
@inject NavigationManager navigationManager
@inject IReservationHelper ReservationHelper

<MudCard Elevation="25">
    <MudTable T="HotelReservation" Items="HotelReservationList" Filter="@(new Func<HotelReservation,bool>(FilterFunc))" Hover="@true" Dense="@Dense" SelectedItemChanged="@(item => ShowDetails(item.Id))">
        <ToolBarContent>
            <MudToolBarSpacer />
            <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.Id))">Id</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => GetClientValue(x.Client)))">Client</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.RoomReservations.Count))">Room List</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.NumberOfGuests))">Number of guests</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.DateFrom))">Arrival</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.DateTo))">Departure</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.Price))">Price</MudTableSortLabel></MudTh>
            <MudTh Class="hss-table-header"><MudTableSortLabel SortBy="@(new Func<HotelReservation, object>(x => x.DateOfSubmission))">Date of submission</MudTableSortLabel></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Client">@GetClientValue(context.Client)</MudTd>
            <MudTd DataLabel="Rooms">@GetRoomValues(context.RoomReservations)</MudTd>
            <MudTd DataLabel="Number of guests">@context.NumberOfGuests</MudTd>
            <MudTd DataLabel="Arrival">@context.DateFrom.ToString(Constants.DefaultDateFormat)</MudTd>
            <MudTd DataLabel="Departure">@context.DateTo.ToString(Constants.DefaultDateFormat)</MudTd>
            <MudTd DataLabel="Price">@context.Price</MudTd>
            <MudTd DataLabel="Date of submission">@context.DateOfSubmission</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="@HssPagingSize.DefaultPageSize"/>
        </PagerContent>
    </MudTable>
</MudCard>

@code {
    
    [Parameter]
    public List<HotelReservation> HotelReservationList { get; set; }

    private string searchString = string.Empty;
    
    [Parameter]
    public bool Dense { get; set; }

    private void ShowDetails(int id)
    {
        navigationManager.NavigateTo($"hotelReservationDetails/{id}");
    }
    
    public bool FilterFunc(HotelReservation hotelReservation)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (hotelReservation.Id.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (GetClientValue(hotelReservation.Client).Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private string GetClientValue(Client client) => ReservationHelper.GetClientFirstNameLastName(client);

    private string GetRoomValues(ICollection<RoomReservation> roomReservation) => ReservationHelper.GetRoomValues(roomReservation);
}